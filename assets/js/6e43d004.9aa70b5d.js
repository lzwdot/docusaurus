"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[49371],{3905:(n,e,t)=>{t.d(e,{Zo:()=>p,kt:()=>h});var o=t(67294);function r(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function l(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(n);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),t.push.apply(t,o)}return t}function a(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?l(Object(t),!0).forEach((function(e){r(n,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(t,e))}))}return n}function i(n,e){if(null==n)return{};var t,o,r=function(n,e){if(null==n)return{};var t,o,r={},l=Object.keys(n);for(o=0;o<l.length;o++)t=l[o],e.indexOf(t)>=0||(r[t]=n[t]);return r}(n,e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(n);for(o=0;o<l.length;o++)t=l[o],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(r[t]=n[t])}return r}var s=o.createContext({}),d=function(n){var e=o.useContext(s),t=e;return n&&(t="function"==typeof n?n(e):a(a({},e),n)),t},p=function(n){var e=d(n.components);return o.createElement(s.Provider,{value:e},n.children)},c={inlineCode:"code",wrapper:function(n){var e=n.children;return o.createElement(o.Fragment,{},e)}},u=o.forwardRef((function(n,e){var t=n.components,r=n.mdxType,l=n.originalType,s=n.parentName,p=i(n,["components","mdxType","originalType","parentName"]),u=d(t),h=r,m=u["".concat(s,".").concat(h)]||u[h]||c[h]||l;return t?o.createElement(m,a(a({ref:e},p),{},{components:t})):o.createElement(m,a({ref:e},p))}));function h(n,e){var t=arguments,r=e&&e.mdxType;if("string"==typeof n||r){var l=t.length,a=new Array(l);a[0]=u;var i={};for(var s in e)hasOwnProperty.call(e,s)&&(i[s]=e[s]);i.originalType=n,i.mdxType="string"==typeof n?n:r,a[1]=i;for(var d=2;d<l;d++)a[d]=t[d];return o.createElement.apply(null,a)}return o.createElement.apply(null,t)}u.displayName="MDXCreateElement"},89288:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>s,contentTitle:()=>a,default:()=>c,frontMatter:()=>l,metadata:()=>i,toc:()=>d});var o=t(87462),r=(t(67294),t(3905));const l={title:"\u624b\u5199\u7b80\u6613\u7248 Vue 2.0.2",ID:"28778",date:"2021-12-27 14:26:47",categories:["frame","vue-study"],tags:["frame","vue-study"],authors:["lzw"],slug:"/28778",type:"docs"},a="\u7b80\u6613\u7248 Vue 2.0.2, \u589e\u52a0\u529f\u80fd",i={unversionedId:"vue-study/28778",id:"vue-study/28778",title:"\u624b\u5199\u7b80\u6613\u7248 Vue 2.0.2",description:"\u589e\u52a0 $mount(el) \uff0c\u4f5c\u7528\uff1a",source:"@site/docs/vue-study/28778.md",sourceDirName:"vue-study",slug:"/28778",permalink:"/docusaurus/docs/28778",draft:!1,editUrl:"https://github.com/lzwdot/docusaurus/docs/vue-study/28778.md",tags:[{label:"frame",permalink:"/docusaurus/docs/tags/frame"},{label:"vue-study",permalink:"/docusaurus/docs/tags/vue-study"}],version:"current",frontMatter:{title:"\u624b\u5199\u7b80\u6613\u7248 Vue 2.0.2",ID:"28778",date:"2021-12-27 14:26:47",categories:["frame","vue-study"],tags:["frame","vue-study"],authors:["lzw"],slug:"/28778",type:"docs"},sidebar:"tutorialSidebar",previous:{title:"\u624b\u5199\u7b80\u6613\u7248 Vue 2.0.1",permalink:"/docusaurus/docs/28654"},next:{title:"\u957f\u5217\u8868\u4f18\u5316 vue \u7248",permalink:"/docusaurus/docs/29203"}},s={},d=[],p={toc:d};function c(n){let{components:e,...t}=n;return(0,r.kt)("wrapper",(0,o.Z)({},p,t,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"\u7b80\u6613\u7248-vue-202-\u589e\u52a0\u529f\u80fd"},"\u7b80\u6613\u7248 Vue 2.0.2, \u589e\u52a0\u529f\u80fd"),(0,r.kt)("p",null," \u589e\u52a0 ",(0,r.kt)("inlineCode",{parentName:"p"},"$mount(el)")," \uff0c\u4f5c\u7528\uff1a  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u83b7\u53d6\u5bbf\u4e3b"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"updateComponet")),(0,r.kt)("li",{parentName:"ul"},"\u521b\u5efa ",(0,r.kt)("inlineCode",{parentName:"li"},"Watcher"),"   ")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"Watcher")," \u6539\u9020  "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u80fd\u591f\u4f20\u5165 ",(0,r.kt)("inlineCode",{parentName:"li"},"updateComponet")),(0,r.kt)("li",{parentName:"ul"},"\u548c ",(0,r.kt)("inlineCode",{parentName:"li"},"dep")," \u5bf9\u5e94\u5173\u7cfb ",(0,r.kt)("inlineCode",{parentName:"li"},"1:n"))),(0,r.kt)("p",null,"\u6d4b\u8bd5\u4ee3\u7801"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <title>Title</title>\n</head>\n<body>\n<div id=\"app\"></div>\n<script src=\"./kvue.js\"><\/script>\n<script>\n  const app = new Kvue({\n    el: '#app',\n    data: {\n      counter: 1,\n    },\n    render(h) {\n      // const d1 = document.createElement('div')\n      // d1.id = 'app'\n      // const p1 = document.createElement('p')\n      // p1.textContent = this.counter\n      // d1.appendChild(p1)\n      // return d1\n\n      // \u4f7f\u7528 h \u51fd\u6570\n      return h('div', {id: 'app', title: this.counter}, [\n        h('p', null, this.counter + '')\n      ])\n    }\n  })\n  setInterval(() => {\n    app.counter++\n  }, 1000)\n<\/script>\n</body>\n</html>\n")),(0,r.kt)("p",null,"\u5347\u7ea7\u7248\u7684\u7b80\u6613\u7248 Vue 2.0"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"/**\n \u589e\u52a0 `$mount(el)` \uff0c\u4f5c\u7528\uff1a\n\n - \u83b7\u53d6\u5bbf\u4e3b\n - `updateComponet`\n - \u521b\u5efa `Watcher`\n\n `Watcher` \u6539\u9020\n\n - \u80fd\u591f\u4f20\u5165 `updateComponet`\n - \u548c `dep` \u5bf9\u5e94\u5173\u7cfb `1:n`\n */\n\n\n/**\n * 1\u3001\u5bf9 data \u9009\u9879\u8fdb\u884c\u54cd\u5e94\u5f0f\u5904\u7406\n * 2\u3001\u7f16\u8f91\u6a21\u677f\n * 3\u3001\u6307\u4ee4\u548c\u4e8b\u4ef6\n * 4\u3001\u4f9d\u8d56\u6536\u96c6\n */\nclass Kvue {\n  constructor(options) {\n    this.$options = options\n    this.$data = options.data\n    // \u54cd\u5e94\u5f0f\n    observe(this.$data)\n\n    // \u4ee3\u7406\u4e0b\n    proxy(this)\n\n    // compile \u7f16\u8f91\u6a21\u677f\n    // new Compile(options.el, this)\n\n    if (options.el) {\n      this.$mount(options.el)\n    }\n  }\n\n  $mount(el) {\n    // \u83b7\u53d6\u5bbf\u4e3b\n    this.$el = document.querySelector(el)\n\n    // \u521b\u5efa updateComponent\n    const updateComponent = () => {\n      // \u83b7\u53d6\u6e32\u67d3\u51fd\u6570\n      const {render} = this.$options\n      const vnode = render.call(this, this.$createElement)\n      // vnode \u53d8\u6210 dom\n      this._update(vnode)\n\n      // const parent = this.$el.parentElement\n      // parent.insertBefore(el, this.$el.nextSibling)\n      // parent.removeChild(this.$el)\n      // this.$el = el\n    }\n\n    // \u521b\u5efa\u6839\u7ec4\u4ef6\u5bf9\u5e94\u7684 Watcher\n    new Watcher(this, updateComponent)\n  }\n\n  // h \u51fd\u6570\n  $createElement(tag, props, children) {\n    return {tag, props, children}\n  }\n\n  _update(vnode) {\n    const prevVnode = this._vnode\n\n    if (!prevVnode) {\n      // init\n      this.__patch__(this.$el, vnode)\n\n    } else {\n      // update\n      this.__patch__(prevVnode, vnode)\n    }\n  }\n\n  __patch__(oldVnode, vnode) {\n    // dom\n    if (oldVnode.nodeType) {\n      const parent = oldVnode.parentElement\n      const refElm = oldVnode.nextSibling\n      const el = this.createElm(vnode)\n      parent.insertBefore(el, refElm)\n      parent.removeChild(oldVnode)\n\n      // \u4fdd\u5b58\u5f53\u524d vnode\n      this._vnode = vnode\n    } else {\n      // update\n      // \u83b7\u53d6 el\n      const el = vnode.el = oldVnode.el\n      //\u76f8\u540c\u8282\u70b9\n      if (oldVnode.tag === vnode.tag) {\n        // props \u65b0\u65e7\u5bf9\u6bd4\n        const oldProps = oldVnode.props || {}\n        const newProps = vnode.props || {}\n\n        // \u5c5e\u6027\u66f4\u65b0\n        for (const key in oldProps) {\n          const oldValue = oldProps[key]\n          const newValue = newProps[key]\n          if (oldValue !== newValue) {\n            el.setAttribute(key, newValue)\n          }\n        }\n\n        // \u5c5e\u6027\u5220\u9664\n        for (const key in oldProps) {\n          if (!(key in newProps)) {\n            el.removeAttribute(key)\n          }\n        }\n\n        // children\n        const oldCh = oldVnode.children\n        const newCh = vnode.children\n        if (typeof newCh === 'string') {\n          if (typeof oldCh === 'string') {\n            // \u65b0\u65e7\u6587\u672c\u90fd\u5b58\u5728\u4e14\u4e0d\u540c\n            if (oldCh !== newCh) {\n              el.textContent = newCh\n            }\n          } else {\n            // \u65e7\u7684\u6ca1\u6709\u6587\u672c\n            el.textContent = newCh\n          }\n        }else{\n          // children\n          if (typeof oldCh === 'string') {\n            el.innerHTML = ''\n            newCh.forEach(child => this.createElm(child))\n          } else {\n            // updateChildren\n            this.updateChildren(el, oldCh, newCh)\n          }\n        }\n      }\n    }\n  }\n\n  createElm(vnode) {\n    const el = document.createElement(vnode.tag)\n    // props\n    if (vnode.props) {\n      for (const key in vnode.props) {\n        const value = vnode.props[key]\n        el.setAttribute(key, value)\n      }\n    }\n\n    // children\n    if (vnode.children) {\n      if (typeof vnode.children === 'string') {\n        // text\n        el.textContent = vnode.children\n      } else {\n        // \u9012\u5f52\n        vnode.children.forEach(n => {\n          const child = this.createElm(n)\n          el.appendChild(child)\n        })\n      }\n    }\n\n    vnode.el = el\n    return el\n  }\n\n  updateChildren(parentElm, oldCh, newCh) {\n    const len = Math.min(oldCh.length, newCh.length)\n    for (let i = 0; i < len; i++) {\n      this.__patch__(oldCh[i], newCh[i])\n    }\n\n    if (newCh.length > oldCh.length) {\n      // add\n      newCh.slice(len).forEach(child => {\n        const el = this.createElm(child)\n        parentElm.appendChild(el)\n      })\n    } else if (newCh.length < oldCh.length) {\n      // remove\n      oldCh.slice(len).forEach(child => {\n        const el = this.createElm(child)\n        parentElm.removeChild(el)\n      })\n    }\n  }\n}\n\n\n// \u6570\u636e\u54cd\u5e94\u5f0f\nfunction defineReactive(obj, key, val) {\n  // \u9012\u5f52\u4e0b\uff0c\u517c\u5bb9 obj[key] = {a:10}\n  observe(obj[key])\n\n  // \u521b\u5efa Key\u3001Dep\u3001Watcher \u7684\u4f9d\u8d56\n  const dep = new Dep()\n\n  Object.defineProperty(obj, key, {\n    get() {\n      console.log('get', key)\n      // \u4f9d\u8d56\u6536\u96c6\n      Dep.target && dep.addDep(Dep.target)\n      return val\n    },\n    set(newVal) {\n      if (newVal !== val) {\n        console.log('set', key)\n        // \u5982\u679c newVal \u662f\u5bf9\u8c61\uff0c\u505a\u54cd\u5e94\u5f0f\u5904\u7406\uff0c\u6bd4\u5982 obj.key = {a:10}\n        observe(newVal)\n        val = newVal\n\n        // watcher \u66f4\u65b0\n        // watchers.forEach(w => w.update())\n        dep.notify()\n      }\n    }\n  })\n}\n\n// \u904d\u5386 obj, \u5bf9\u6240\u6709\u5c5e\u6027\u505a\u54cd\u5e94\u5f0f\nfunction observe(obj) {\n  if (typeof obj !== 'object' || obj == null) {\n    return\n  }\n\n  new Observer(obj)\n}\n\n\n// \u4ee3\u7406\uff0c\u5b9e\u73b0\u7684\u76ee\u7684 vm.$data.counter \u53ef\u4ee5\u901a\u8fc7 vm.counter \u62ff\u5230\nfunction proxy(vm) {\n  Object.keys(vm.$data).forEach(key => {\n    Object.defineProperty(vm, key, {\n      get() {\n        return vm.$data[key]\n      },\n      set(v) {\n        vm.$data[key] = v\n      }\n    })\n  })\n}\n\n\n// \u6839\u636e\u4e0d\u540c\u7c7b\u578b\u505a\u54cd\u5e94\u5f0f\u5904\u7406\nclass Observer {\n  constructor(value) {\n    this.value = value\n\n    if (Array.isArray(value)) {\n      // todo\n    } else {\n      this.walk(value)\n    }\n  }\n\n  walk(obj) {\n    Object.keys(obj).forEach(key => {\n      defineReactive(obj, key, obj[key])\n    })\n  }\n}\n\n// \u89e3\u6790\u6a21\u677f\uff0c1\u3001\u5904\u7406\u63d2\u503c\uff0c2\u3001\u5904\u7406\u6307\u4ee4\u548c\u4e8b\u4ef6\uff0c3\u3001\u4ee5\u4e0a\u4e24\u8005\u7684\u521d\u59cb\u5316\u548c\u66f4\u65b0\n\nclass Compile {\n  constructor(el, vm) {\n    this.$vm = vm\n    this.$el = document.querySelector(el)\n\n    if (this.$el) {\n      this.compile(this.$el)\n    }\n  }\n\n  compile(el) {\n    // \u904d\u5386 el \u5b50\u8282\u70b9\uff0c\u5224\u65ad\u7c7b\u578b\u505a\u76f8\u5e94\u7684\u5904\u7406\n    const childNodes = el.childNodes\n\n    childNodes.forEach(node => {\n      if (node.nodeType === 1) {\n        // \u5143\u7d20\n        // console.log('\u5143\u7d20', node.nodeName)\n        // \u5904\u7406 \u6307\u4ee4\u548c\u4e8b\u4ef6\n        const attrs = node.attributes\n        Array.from(attrs).forEach(attr => {\n          // k-xxx=\"abc\"\n          const attrName = attr.name\n          const exp = attr.value\n          if (attrName.startsWith('k-')) {\n            const dir = attrName.substring(2)\n            this[dir] && this[dir](node, exp)\n          }\n        })\n      } else if (this.isInter(node)) {\n        // \u6587\u672c \u63d2\u503c\u8868\u8fbe\u5f0f\n        // console.log('\u63d2\u503c', node.textContent)\n        this.compileText(node)\n      }\n\n      // \u9012\u5f52\u4e0b\n      if (node.childNodes) {\n        this.compile(node)\n      }\n    })\n  }\n\n  // \u9ad8\u7ea7\u51fd\u6570\u6267\u884c dir\n  update(node, exp, dir) {\n    // 1\u3001\u521d\u59cb\u5316\n    const fn = this[dir + 'Updater']\n    fn && fn(node, this.$vm[exp])\n\n    // 2\u3001\u66f4\u65b0\u64cd\u4f5c\n    new Watcher(this.$vm, exp, function (val) {\n      fn && fn(node, val)\n    })\n  }\n\n  // \u5bf9\u5e94\u7684 k-text \u7684\u6307\u4ee4\n  text(node, exp) {\n    // node.textContent = this.$vm[exp]\n    this.update(node, exp, 'text')\n  }\n\n  textUpdater(node, value) {\n    node.textContent = value\n  }\n\n  // \u7f16\u8bd1 {{xxx}}\u6587\u672c\n  compileText(node) {\n    // node.textContent = this.$vm[RegExp.$1]\n    this.update(node, RegExp.$1, 'text')\n  }\n\n  // \u5bf9\u5e94\u7684 k-html \u7684\u6307\u4ee4\n  html(node, exp) {\n    // node.innerHTML = this.$vm[exp]\n    this.update(node, exp, 'html')\n  }\n\n  htmlUpdater(node, value) {\n    node.innerHTML = value\n  }\n\n  // \u662f\u5426\u63d2\u503c\u8868\u8fbe\u5f0f\n  isInter(node) {\n    return node.nodeType === 3 && /\\{\\{(.*)\\}\\}/.test(node.textContent)\n  }\n}\n\n// \u76d1\u7763\u5668\uff1a\u8d1f\u8d23\u4f9d\u8d56\u66f4\u65b0\uff0c\u6709\u591a\u5c11\u4e2a\u53d8\u91cf\u5c31\u6709\u591a\u5c11\u4e2a watcher\n// const watchers = []\n\nclass Watcher {\n  constructor(vm, fn) {\n    this.vm = vm\n    // this.key = key\n    // this.updateFn = updateFn\n    this.getter = fn\n\n    // watchers.push(this)\n    // Dep.target = this\n    // \u76f8\u5f53\u4e8e\u8c03\u7528\u4e86\u4e00\u6b21 key \u7684 get \u65b9\u6cd5\u8fdb\u884c\u4f9d\u8d56\u6536\u9f50\n    // this.vm[this.key]\n    // Dep.target = null\n\n    this.get()\n  }\n\n  get() {\n    Dep.target = this\n    this.getter.call(this.vm)\n    Dep.target = null\n  }\n\n  // \u88ab Dep \u8c03\u7528\u7684\n  update() {\n    // \u6267\u884c\u5b9e\u9645\u7684\u66f4\u65b0\u64cd\u4f5c\n    // this.updateFn.call(this.vm, this.vm[this.key])\n    this.get()\n  }\n}\n\n// \u5b9e\u73b0 Dep\uff0c\u6709\u591a\u5c11\u4e2a key \u5c31\u6709\u591a\u5c11\u4e2a dep\nclass Dep {\n  constructor() {\n    // this.deps = []\n    this.deps = new Set()\n  }\n\n  addDep(dep) {\n    // \u8fd9\u91cc\u7684 dep \u5176\u5b9e\u5c31\u662f watcher\n    // this.deps.push(dep)\n    this.deps.add(dep)\n  }\n\n  notify() {\n    // \u8fd9\u91cc\u7684 dep \u5176\u5b9e\u5c31\u662f watcher\n    this.deps.forEach(dep => dep.update())\n  }\n}\n")))}c.isMDXComponent=!0}}]);