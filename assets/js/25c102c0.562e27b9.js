"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[60995],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>f});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var o=a.createContext({}),p=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},d=function(e){var n=p(e.components);return a.createElement(o.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=p(t),f=r,m=u["".concat(o,".").concat(f)]||u[f]||c[f]||l;return t?a.createElement(m,i(i({ref:n},d),{},{components:t})):a.createElement(m,i({ref:n},d))}));function f(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,i=new Array(l);i[0]=u;var s={};for(var o in n)hasOwnProperty.call(n,o)&&(s[o]=n[o]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<l;p++)i[p]=t[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},29610:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>f,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var a=t(87462),r=(t(67294),t(3905));const l={title:"\u6587\u4ef6\u4e0a\u4f20\u548c\u4f18\u5316",ID:"29206",date:"2022-01-18 20:52:22",categories:["js-ts","js-study"],tags:["js-ts","js-study"],authors:["lzw"],slug:"/29206",type:"blog"},i=void 0,s={permalink:"/docusaurus/blog/29206",editUrl:"https://github.com/lzwdot/docusaurus/blog/2022/01-18-29206.md",source:"@site/blog/2022/01-18-29206.md",title:"\u6587\u4ef6\u4e0a\u4f20\u548c\u4f18\u5316",description:"\u6587\u4ef6\u683c\u5f0f\u5224\u65ad\u548c\u5927\u5c0f\u5224\u65ad",date:"2022-01-18T20:52:22.000Z",formattedDate:"2022\u5e741\u670818\u65e5",tags:[{label:"js-ts",permalink:"/docusaurus/blog/tags/js-ts"},{label:"js-study",permalink:"/docusaurus/blog/tags/js-study"}],readingTime:15.78,hasTruncateMarker:!0,authors:[{name:"lzw.",title:"\u4e00\u4e2a web \u5f00\u53d1\u8005",url:"https://github.com/lzwdot",imageURL:"https://avatars.githubusercontent.com/u/24477920?v=4",key:"lzw"}],frontMatter:{title:"\u6587\u4ef6\u4e0a\u4f20\u548c\u4f18\u5316",ID:"29206",date:"2022-01-18 20:52:22",categories:["js-ts","js-study"],tags:["js-ts","js-study"],authors:["lzw"],slug:"/29206",type:"blog"},prevItem:{title:"JS \u7cbe\u5ea6\u95ee\u9898\u7531\u6765\u53ca\u89e3\u51b3",permalink:"/docusaurus/blog/29458"},nextItem:{title:"\u9879\u76ee\u4eae\u70b9\u5b9e\u6218",permalink:"/docusaurus/blog/28802"}},o={authorsImageUrls:[void 0]},p=[],d=(c="HtmlDemo",function(e){return console.warn("Component "+c+" was not imported, exported, or provided by MDXProvider as global scope"),(0,r.kt)("div",e)});var c;const u={toc:p};function f(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"\u6587\u4ef6\u4e0a\u4f20\u548c\u4f18\u5316"},"\u6587\u4ef6\u4e0a\u4f20\u548c\u4f18\u5316"),(0,r.kt)("p",null,"\u6587\u4ef6\u683c\u5f0f\u5224\u65ad\u548c\u5927\u5c0f\u5224\u65ad"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u5224\u65ad\u683c\u5f0f"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u65b9\u5f0f\u4e00 \u5728 input",'[type="file"]'," \u6dfb\u52a0 ",(0,r.kt)("inlineCode",{parentName:"p"},'accept=".png,.jpg,.jpeg"')," \u9009\u62e9\u6587\u4ef6\u65f6\u9650\u5236\uff0c\u9650\u5236\u4e0d\u4e86\u62d6\u62fd\u4e0a\u4f20")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u65b9\u5f0f\u4e8c \u901a\u8fc7 file.type \u6b63\u5219\u9650\u5236 ",(0,r.kt)("inlineCode",{parentName:"p"},"!/(jpg|jpeg|png)/i.test(file.type)"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u65b9\u5f0f\u4e09 \u901a\u8fc7\u4e8c\u8fdb\u5236\u5934\u4fe1\u606f"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const fileReader = new FileReader()\nfileReader.readAsArrayBuffer(file)\nfileReader.onload = function (e) {\n  const result = new Uint8Array(e.target.result)\n\n  if (result.join('').indexOf('255216') === 0) {\n    console.log('jpg\u6587\u4ef6')\n  } else if (result.join('').indexOf('13780') === 0) {\n    console.log('png\u6587\u4ef6')\n  }\n}\n")))))),(0,r.kt)("p",null,"\u6587\u4ef6\u4e0a\u4f20\u3010form-data\uff0c\u6587\u4ef6\u552f\u4e00hash\uff0c\u8fdb\u5ea6\u6761\uff0c\u591a\u6587\u4ef6\u3011"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"form-data \u65b9\u5f0f\u4e0a\u4f20",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u8bbe\u7f6e ",(0,r.kt)("inlineCode",{parentName:"li"},"Content-Type:multipart/form-data")," \u5934\u4fe1\u606f"),(0,r.kt)("li",{parentName:"ul"},"\u91c7\u7528 ",(0,r.kt)("inlineCode",{parentName:"li"},"(new FormData()).formData.append('file', file)")," \u65b9\u5f0f\u4e0a\u4f20"))),(0,r.kt)("li",{parentName:"ul"},"\u6587\u4ef6\u552f\u4e00 hash \u540d\u79f0",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u91c7\u7528 ",(0,r.kt)("inlineCode",{parentName:"li"},"(new FileReader()).readAsArrayBuffer(file)")," \u8bfb\u53d6\u6587\u4ef6\u4e3a ArrayBuffer \u683c\u5f0f"),(0,r.kt)("li",{parentName:"ul"},"\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"li"},"spark-md5")," \u751f\u6210 hash \u540d\u79f0"))),(0,r.kt)("li",{parentName:"ul"},"\u4e0a\u4f20\u8fdb\u5ea6\u6761",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u76d1\u542c axios \u4e2d ",(0,r.kt)("inlineCode",{parentName:"li"},"onUploadProgress(e)")," \u65b9\u5f0f"),(0,r.kt)("li",{parentName:"ul"},"\u5176\u5b9e\u9645\u5c31\u662f ajax \u4e2d ",(0,r.kt)("inlineCode",{parentName:"li"},"xhr.upload.onprogress(e)")," \u65b9\u6cd5"),(0,r.kt)("li",{parentName:"ul"},"\u767e\u5206\u6bd4\u8ba1\u7b97 ",(0,r.kt)("inlineCode",{parentName:"li"},"e.loaded / e.total")))),(0,r.kt)("li",{parentName:"ul"},"\u591a\u6587\u4ef6\u4e0a\u4f20",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u5728 input",'[type="file"]'," \u6dfb\u52a0 ",(0,r.kt)("inlineCode",{parentName:"li"},"multiple")," \u5c5e\u6027"),(0,r.kt)("li",{parentName:"ul"},"\u5229\u7528 input",'[type="file"]',"  \u5bf9\u8c61\u4e2d\u7684 ",(0,r.kt)("inlineCode",{parentName:"li"},"files")," \u83b7\u53d6\u5230\u6240\u6709\u6587\u4ef6\u5bf9\u8c61\uff0c\u5faa\u73af\u4e0a\u4f20")))),(0,r.kt)("p",null,"\u6587\u4ef6\u4e0a\u4f20\u3010base64\uff0c\u7f29\u7565\u56fe\uff0c\u62d6\u62fd\u4e0a\u4f20\uff0c\u5927\u6587\u4ef6\u65ad\u70b9\u7eed\u4f20\u3011 "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"base64  & \u7f29\u7565\u56fe",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u4e00\u822c\u7528\u4e8e\u5904\u7406\u5c0f\u7684\u56fe\u7247\uff0c\u53ef\u4ee5\u9884\u89c8\u7f29\u7565\u56fe"),(0,r.kt)("li",{parentName:"ul"},"\u91c7\u7528 ",(0,r.kt)("inlineCode",{parentName:"li"},"(new FileReader()).readAsDataURL(file)")," \u8bfb\u53d6\u6587\u4ef6\u4e3a DataURL \u683c\u5f0f\uff0c\u53ef\u4ee5\u5728\u6d4f\u89c8\u5668\u4e0a\u76f4\u63a5\u8bbf\u95ee"))),(0,r.kt)("li",{parentName:"ul"},"\u62d6\u62fd\u4e0a\u4f20",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u76d1\u542c html5 \u5143\u7d20 ",(0,r.kt)("inlineCode",{parentName:"li"},"dragover")," \u548c ",(0,r.kt)("inlineCode",{parentName:"li"},"drop")," \u4e8b\u4ef6\uff0c\u9700\u8981\u963b\u6b62\u9ed8\u8ba4\u4e8b\u4ef6 ",(0,r.kt)("inlineCode",{parentName:"li"},"e.preventDefault()")),(0,r.kt)("li",{parentName:"ul"},"\u5728 drop \u4e8b\u4ef6\u4e2d\u901a\u8fc7 ",(0,r.kt)("inlineCode",{parentName:"li"},"e.dataTransfer.files")," \u83b7\u53d6\u5230\u6587\u4ef6\u5bf9\u8c61\uff0c\u5373\u53ef\u4e0a\u4f20"))),(0,r.kt)("li",{parentName:"ul"},"\u5927\u6587\u4ef6\u65ad\u70b9\u7eed\u4f20",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"li"},"\u56fa\u5b9a\u6570\u91cf & \u56fa\u5b9a\u5927\u5c0f"),"\u65b9\u6848\u751f\u6210\u5207\u7247\uff0c\u5982\u679c\u5207\u7247\u6570\u91cf\u5927\u4e8e\u6700\u5927\u503c\uff0c\u5c31\u6839\u636e\u6570\u91cf\u751f\u4ea7\u5207\u7247\u5927\u5c0f"),(0,r.kt)("li",{parentName:"ul"},"\u4f7f\u7528\u6587\u4ef6\u5bf9\u8c61\u4e2d ",(0,r.kt)("inlineCode",{parentName:"li"},"file.slice")," \u8fdb\u884c\u5207\u5272\uff0c\u5207\u7247\u540d\u79f0\u4e3a ",(0,r.kt)("inlineCode",{parentName:"li"},"${hash}_${i}"),"\uff08",(0,r.kt)("inlineCode",{parentName:"li"},"spark-md5")," \u751f\u6210\u6587\u4ef6\u552f\u4e00 hash\uff0c",(0,r.kt)("inlineCode",{parentName:"li"},"i")," \u4e3a\u5207\u7247\u5e8f\u53f7\uff09"),(0,r.kt)("li",{parentName:"ul"},"\u4e0a\u4f20\u4e4b\u524d\uff0c\u8c03\u63a5\u53e3\u83b7\u53d6\u5df2\u4e0a\u4f20\u5207\u7247\u6570\u7ec4"),(0,r.kt)("li",{parentName:"ul"},"\u5faa\u73af\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"li"},"FormData")," \u4e0a\u4f20\u672a\u4e0a\u4f20\u7684\u5207\u7247\uff0c\u4e0a\u4f20\u5931\u8d25\u7684\u5207\u7247\u653e\u5230\u5931\u8d25\u6570\u7ec4\u91cc\uff0c\u91cd\u65b0\u4e0a\u4f20"),(0,r.kt)("li",{parentName:"ul"},"\u4e0a\u4f20\u5b8c\u6210\u540e\uff0c\u8c03\u63a5\u53e3\u53d1\u9001\u4e0a\u4f20\u5b8c\u6210\u6307\u4ee4")))),(0,r.kt)("p",null,"\u4f7f\u7528 webwork \u4f18\u5316\u5927\u6587\u4ef6 hash \u751f\u4ea7\uff0c\u9632\u6b62\u9875\u9762\u5047\u6b7b"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"onmessage = function (e) {\n  importScripts('../node_modules/spark-md5/spark-md5.min.js');\n\n  const file = e.data\n  const fileReader = new FileReader()\n\n  fileReader.readAsArrayBuffer(file)\n  fileReader.onload = ev => {\n    const buffer = ev.target.result\n    const spark = new SparkMD5.ArrayBuffer()\n    spark.append(buffer)\n    const hash = spark.end()\n    const suffix = /\\.([a-zA-Z0-9]+)$/.exec(file.name)[1]\n\n    postMessage({\n      buffer, hash, suffix, filename: `${hash}.${suffix}`\n    })\n  }\n}\n")),(0,r.kt)("p",null,"\u5b8c\u6574\u4ee3\u7801"),(0,r.kt)(d,{mdxType:"HtmlDemo"},(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},"<link href=\"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css\" rel=\"stylesheet\">\n<style>\n    input[type=\"file\"] {\n        display: none;\n    }\n\n    .container, .row {\n        margin-top: 20px;\n    }\n\n    .input-group {\n        display: block;\n        padding: 10px;\n        min-height: 200px;\n        border: 1px #ccc dashed;\n        position: relative\n    }\n\n    .disable,\n    .loading {\n        pointer-events: none;\n        background-color: #ccc;\n    }\n\n    .list-group,\n    .spinner-border,\n    .img-wrap,\n    .progress {\n        display: none;\n    }\n\n    .loading .spinner-border {\n        display: inline-block;\n    }\n\n    .drag-upload {\n        height: 100px;\n        width: 100%;\n        text-align: center;\n        color: #999;\n    }\n\n    .upload-ing {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background-color: rgba(0, 0, 0, 0.8);\n        display: none;\n        align-items: center;\n        justify-content: center;\n        color: #fff;\n        z-index: 100;\n    }\n</style>\n<div class=\"container\">\n    <div class=\"row\">\n        <div class=\"col\" id=\"upload1\">\n            <b>\u6587\u4ef6\u4e0a\u4f20\u3010form-data\uff0c\u6587\u4ef6\u552f\u4e00hash\uff0c\u8fdb\u5ea6\u6761\uff0c\u591a\u6587\u4ef6\u3011</b>\n            <div class=\"input-group\">\n                <label class=\"btn btn-primary\" for=\"inputGroupFile01\">\n                    \u9009\u62e9\u6587\u4ef6\n                </label>\n                \x3c!--  accept=\".png,.jpg,.jpeg\" \u9650\u5b9a\u6587\u4ef6\u683c\u5f0f --\x3e\n                <input type=\"file\" class=\"form-control\" id=\"inputGroupFile01\" multiple>\n                <button type=\"button\" class=\"btn btn-success\">\n                    <span class=\"spinner-border spinner-border-sm\" role=\"status\" aria-hidden=\"true\"></span>\n                    \u4e0a\u4f20\u5230\u670d\u52a1\u5668\n                </button>\n                <p><small class=\"text-muted\">\u53ea\u80fd\u4e0a\u4f20 png/jgp/jpeg \u683c\u5f0f\u56fe\u7247\uff0c\u5927\u5c0f\u4e0d\u8d85\u8fc7 50MB</small></p>\n                <ul class=\"list-group\">\n                    \x3c!--<li class=\"list-group-item d-flex justify-content-between align-items-center\">--\x3e\n                    \x3c!--    test--\x3e\n                    \x3c!--    <span class=\"badge bg-primary rounded-pill\">test</span>--\x3e\n                    \x3c!--</li>--\x3e\n                </ul>\n                <div class=\"progress\">\n                    <div class=\"progress-bar\" role=\"progressbar\"></div>\n                </div>\n            </div>\n        </div>\n    </div>\n    <div class=\"row\">\n        <div class=\"col\" id=\"upload2\">\n            <b>\u6587\u4ef6\u4e0a\u4f20\u3010base64\uff0c\u7f29\u7565\u56fe\uff0c\u62d6\u62fd\u4e0a\u4f20\uff0c\u5927\u6587\u4ef6\u65ad\u70b9\u7eed\u4f20\u3011</b>\n            <div class=\"input-group\">\n                <label class=\"btn btn-primary\" for=\"inputGroupFile02\">\n                    <span class=\"spinner-border spinner-border-sm\" role=\"status\" aria-hidden=\"true\"></span>\n                    \u4e0a\u4f20\u56fe\u7247\n                </label>\n                <input type=\"file\" class=\"form-control\" id=\"inputGroupFile02\" accept=\".png,.jpg,.jpeg\">\n                <p><small class=\"text-muted\">\u53ea\u80fd\u4e0a\u4f20 png/jgp/jpeg \u683c\u5f0f\u56fe\u7247\uff0c\u5927\u5c0f\u4e0d\u8d85\u8fc7 50MB</small></p>\n                <div class=\"drag-upload\">\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"50\" height=\"50\" fill=\"currentColor\"\n                         class=\"bi bi-cloud-upload\" viewBox=\"0 0 16 16\">\n                        <path fill-rule=\"evenodd\"\n                              d=\"M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z\"/>\n                        <path fill-rule=\"evenodd\"\n                              d=\"M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z\"/>\n                    </svg>\n                    <p>\u5c06\u6587\u4ef6\u62d6\u5230\u6b64\u5904\uff0c\u6216 <label class=\"link-primary\" for=\"inputGroupFile02\">\u70b9\u51fb\u4e0a\u4f20</label></p>\n                </div>\n                <div class=\"upload-ing\">\u6b63\u5728\u4e0a\u4f20\u4e2d<span class=\"percent\">0%</span>\uff0c\u8bf7\u7a0d\u540e...</div>\n                <div class=\"img-wrap\">\n                    <img src=\"...\" class=\"img-thumbnail\" alt=\"...\">\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n\n\n<script src=\"https://cdn.bootcdn.net/ajax/libs/axios/0.24.0/axios.min.js\"><\/script>\n<script src=\"https://cdn.bootcdn.net/ajax/libs/qs/6.10.3/qs.min.js\"><\/script>\n<script src=\"https://cdn.bootcdn.net/ajax/libs/spark-md5/3.0.2/spark-md5.min.js\"><\/script>\n\n\x3c!--<script src=\"./js/instance.js\"><\/script>--\x3e\n\x3c!--<script src=\"./js/upload.js\"><\/script>--\x3e\n\n<script>\n  // \u516c\u5171\u90e8\u5206\u4fe1\u606f\n  let instance = axios.create() // \u72ec\u7acb\u7684 axios \u5b9e\u4f8b\n  instance.defaults.baseURL = 'http://localhost:8888'\n  instance.defaults.headers['Content-Type'] = 'multipart/form-data'\n  instance.defaults.transformRequest = (data, headers) => {\n    const contentType = headers['Content-Type']\n\n    if (contentType === 'application/x-www-form-urlencoded') {\n      // Qs.stringify(data) : {a:1,b:2} -> a=1&b=2\n      return Qs.stringify(data)\n    }\n\n    return data\n  }\n  instance.interceptors.response.use(res => {\n    return res.data\n  }, error => {\n    // \u7edf\u4e00\u9519\u8bef\u63d0\u793a\n    return Promise.reject(error)\n  });\n\n  // \u6587\u4ef6\u4e0a\u4f20\u3010form-data\uff0c\u6587\u4ef6\u552f\u4e00hash\uff0c\u8fdb\u5ea6\u6761\uff0c\u591a\u6587\u4ef6\u3011\n  (function () {\n    const upload = document.querySelector('#upload1')\n    const upload_inp = upload.querySelector('input.form-control')\n    const upload_button_select = upload.querySelector('label.btn-primary')\n    const upload_button_upload = upload.querySelector('button.btn-success')\n    const upload_tip = upload.querySelector('small.text-muted')\n    const upload_list = upload.querySelector('ul.list-group')\n    const upload_progress = upload.querySelector('.progress')\n    const upload_progress_bar = upload_progress.querySelector('.progress-bar')\n    // \u5b58\u6587\u4ef6\u5bf9\u8c61\n    let _files = []\n\n    const changeDisabel = flag => {\n      if (flag) {\n        upload_button_select.classList.add('disable')\n        upload_button_upload.classList.add('loading')\n        upload_progress.style.display = 'flex'\n        return\n      }\n      upload_button_select.classList.remove('disable')\n      upload_button_upload.classList.remove('loading')\n    }\n\n    // \u6587\u4ef6\u8bfb\u53d6\u6210\u4e3a buffer\n    const changeBuffer = file => {\n      return new Promise(resolve => {\n        const fileReader = new FileReader()\n        fileReader.readAsArrayBuffer(file)\n        fileReader.onload = ev => {\n          const buffer = ev.target.result\n          const spark = new SparkMD5.ArrayBuffer()\n          spark.append(buffer)\n          const hash = spark.end()\n          const suffix = /\\.([a-zA-Z0-9]+)$/.exec(file.name)[1]\n\n          resolve({\n            buffer, hash, suffix, filename: `${hash}.${suffix}`\n          })\n        }\n      })\n    }\n\n    // \u4fee\u6539\u8fdb\u5ea6\u6761\n    const changeProgress = proArr => {\n      let loaded = total = 0\n\n      proArr.forEach(item => {\n        loaded += item.loaded\n        total += item.total\n      })\n\n      upload_progress_bar.style.width = (loaded / total * 100).toFixed(2) + '%'\n    }\n\n    // \u4e0a\u4f20\u6587\u4ef6\u5230\u670d\u52a1\u5668\n    upload_button_upload.addEventListener('click', async function () {\n      if (!_files.length === 0) {\n        alert('\u8bf7\u5148\u9009\u62e9\u4e0a\u4f20\u6587\u4ef6~')\n        return\n      }\n      changeDisabel(true)\n\n      // \u603b\u7684 progress\n      const progressArr = new Map()\n      // \u5faa\u73af\u53d1\u9001\u8bf7\u6c42\n      const upload_list_arr = Array.from(upload_list.querySelectorAll('li'))\n      _files = _files.map(async item => {\n        // \u5f53\u524d li \u548c span\n        const curLi = upload_list_arr.find(li => li.getAttribute('key') === item.key)\n        const curSpan = curLi ? curLi.querySelector('span:nth-last-child(1)') : null\n\n        // \u751f\u4ea7\u6587\u4ef6\u7684 hash\u540d\u79f0\n        const {filename} = await changeBuffer(item.file)\n\n        // \u628a\u6587\u4ef6\u4f20\u9012\u7ed9\u670d\u52a1\u5668\uff1aFormData / Base64\n        const formData = new FormData()\n        formData.append('file', item.file)\n        formData.append('filename', filename || item.filename)\n\n        // axios\n        return instance.post('/upload', formData, {\n          // \u6587\u4ef6\u4e0a\u4f20\u8fdb\u5ea6\u56de\u8c03\u51fd\u6570 xhr.upload.onprogress\n          onUploadProgress(e) {\n            curSpan.innerHTML = `${(e.loaded / e.total * 100).toFixed(2)}%`\n\n            progressArr.set(item.key, e)\n            changeProgress(progressArr)\n          }\n        }).then(data => {\n          if (+data.code === 0) {\n            // alert(`\u6587\u4ef6\u4e0a\u4f20\u6210\u529f\uff0c\u901a\u8fc7${data.servicePath}\u8bbf\u95ee\u8d44\u6e90`)\n            return\n          }\n\n          return Promise.reject(data.codeText)\n        })\n        //   .catch(error => {\n        //   alert('\u6587\u4ef6\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5~')\n        // }).finally(() => {\n        //   clearHandle()\n        // })\n      })\n\n      Promise.all(_files).then(() => {\n        alert(`\u6240\u6709\u6587\u4ef6\u4e0a\u4f20\u6210\u529f`)\n      }).catch(err => {\n        alert('\u6587\u4ef6\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5~')\n      }).finally(() => {\n        clearHandle()\n        changeDisabel(false)\n      })\n    })\n\n    const clearHandle = () => {\n      upload_tip.style.display = 'block'\n      upload_list.style.display = 'none'\n      upload_list.innerHTML = ``\n    }\n    // \u79fb\u9664\u6309\u94ae\u7684\u70b9\u51fb\u4e8b\u4ef6\n    upload_list.addEventListener('click', function (e) {\n      const target = e.target\n      if (target.tagName === 'SPAN') {\n        const curLi = target.parentNode\n        const key = curLi.getAttribute('key')\n        upload_list.removeChild(curLi)\n        _files = _files.filter(item => item.ley !== key)\n        // \u5df2\u7ecf\u6ca1\u6709\u4e86\n        if (_files.length === 0) {\n          clearHandle()\n        }\n      }\n    })\n\n    const checkFile = file => {\n      // \u9650\u5236\u6587\u4ef6\u4e0a\u4f20\u7684\u683c\u5f0f [\u65b9\u68481]\n      if (!/(jpg|jpeg|png)/i.test(file.type)) {\n        alert(file.name + '\u7684 type:' + upload_tip.innerHTML)\n        return false\n      }\n\n      // \u9650\u5236\u6587\u4ef6\u4e0a\u4f20\u5927\u5c0f\u4e0d\u8d85\u8fc7 50MB\n      if (file.size > 50 * 1024 * 1024) {\n        alert(file.name + '\u7684 size:' + upload_tip.innerHTML)\n        return false\n      }\n\n      return true\n    }\n\n    // \u83b7\u53d6\u552f\u4e00\u503c\n    const creatRandom = () => {\n      const random = Math.random() * new Date()\n      // toString(16) \u53d8\u6210 16 \u8fdb\u5236\n      return random.toString(16).replace('.', '')\n    }\n\n    // \u76d1\u542c\u7528\u6237\u9009\u62e9\u6587\u4ef6\u7684\u64cd\u4f5c\n    upload_inp.addEventListener('change', function () {\n      // \u83b7\u53d6\u9009\u4e2d\u6587\u4ef6\u5bf9\u8c61\n      // name:\u6587\u4ef6\u540d\n      // size:\u6587\u4ef6\u5927\u5c0f\n      // type:\u6587\u4ef6\u7684 MIME \u7c7b\u578b\n      _files = Array.from(upload_inp.files)\n      if (_files.length === 0) return\n\n      // \u7ed9\u6bcf\u4e00\u9879\u8bbe\u7f6e\u4e00\u4e2a\u552f\u4e00\uff0c\u6839\u636e\u8fd9\u4e2a\u503c\u8fdb\u884c\u589e\u5220\n      _files = _files.map(file => {\n        return {\n          file,\n          filename: file.name,\n          key: creatRandom()\n        }\n      })\n\n      let str = ``\n      _files.forEach((item, index) => {\n        if (checkFile(item.file)) {\n          str += `<li key=\"${item.key}\" class=\"list-group-item d-flex justify-content-between align-items-center\">\n            \u6587\u4ef6${item}\uff1a${item.filename}<span class=\"badge bg-primary rounded-pill\">\u79fb\u9664</span>\n        </li>`\n        }\n      })\n\n      // \u663e\u793a\u4e0a\u4f20\u7684\u6587\u4ef6\n      upload_tip.style.display = 'none'\n      upload_list.style.display = 'block'\n      upload_list.innerHTML = str\n    })\n  })();\n\n  // \u6587\u4ef6\u4e0a\u4f20\u3010base64\uff0c\u7f29\u7565\u56fe\u5904\u7406\uff08\u53ea\u9002\u5408\u56fe\u7247\uff09\uff0c\u5927\u6587\u4ef6\u65ad\u70b9\u7eed\u4f20\u3011\n  (function () {\n    const upload = document.querySelector('#upload2')\n    const upload_inp = upload.querySelector('input.form-control')\n    const upload_button_select = upload.querySelector('label.btn-primary')\n    const upload_tip = upload.querySelector('small.text-muted')\n    const upload_abbre = upload.querySelector('.img-wrap')\n    const upload_abbre_img = upload.querySelector('img.img-thumbnail')\n    const upload_ing = upload.querySelector('.upload-ing')\n    const upload_percent = upload_ing.querySelector('.percent')\n    let isRun = false\n\n    // \u6587\u4ef6\u8bfb\u53d6\u6210\u4e3a buffer\n    const changeBuffer = file => {\n      return new Promise(resolve => {\n        console.time('test');\n\n        const fileReader = new FileReader()\n        fileReader.readAsArrayBuffer(file)\n        fileReader.onload = e => {\n          const buffer = e.target.result\n          const spark = new SparkMD5.ArrayBuffer()\n          spark.append(buffer)\n          const hash = spark.end()\n          const suffix = /\\.([a-zA-Z0-9]+)$/.exec(file.name)[1]\n\n          console.timeEnd('test');\n          resolve({\n            buffer, hash, suffix, filename: `${hash}.${suffix}`\n          })\n        }\n\n        // \u4f7f\u7528 web Worker \u9632\u6b62\u9875\u9762\u5047\u6b7b\n        // const work = new Worker('./js/work.js')\n        // work.postMessage(file)\n        // work.onmessage = e => {\n        //   console.timeEnd('test');\n        //   resolve(e.data)\n        // }\n      })\n    }\n\n    // \u5b9e\u73b0\u6587\u4ef6\u4e0a\u4f20\n    const uploadFile = async file => {\n      if (isRun) return\n      isRun = true\n\n      // \u9650\u5236\u6587\u4ef6\u4e0a\u4f20\u7684\u683c\u5f0f [\u65b9\u68481]\n      if (!/(jpg|jpeg|png)/i.test(file.type)) {\n        // alert(file.name + '\u7684 type:' + upload_tip.innerHTML)\n        // return false\n      }\n\n      // \u4f7f\u7528\u4e8c\u8fdb\u5236\u5934\u90e8\u9650\u5236\u6587\u4ef6\u7c7b\u578b[\u65b9\u68482] , \u6bd4\u5982jpg:255216 png:13780\n      const fileReader = new FileReader()\n      fileReader.readAsArrayBuffer(file)\n      fileReader.onload = function (e) {\n        const result = new Uint8Array(e.target.result)\n\n        if (result.join('').indexOf('255216') === 0) {\n          console.log('jpg\u6587\u4ef6')\n        } else if (result.join('').indexOf('13780') === 0) {\n          console.log('png\u6587\u4ef6')\n        }\n      }\n\n      // \u9650\u5236\u6587\u4ef6\u4e0a\u4f20\u5927\u5c0f\u4e0d\u8d85\u8fc7 50MB\n      if (file.size > 50 * 1024 * 1024) {\n        // alert(upload_tip.innerHTML)\n        // return false\n      }\n\n      changeDisabel(true)\n\n      // \u5927\u6587\u4ef6\n      if (file.size > 5 * 1024 * 1024) {\n        // \u751f\u4ea7\u6587\u4ef6\u7684 hash\u540d\u79f0\n        const {filename, suffix, hash} = await changeBuffer(file)\n\n        // \u5df2\u5b58\u4e0a\u4f20\u7684\u5207\u7247 \u548c \u6570\u636e\n        let already = []\n        let data = null\n\n        // \u83b7\u53d6\u5df2\u4e0a\u4f20\u7684\u5207\u7247\n        try {\n          data = await instance.post('/getData', {hash, suffix}, {\n            headers: {\n              'Content-Type': 'application/x-www-form-urlencoded'\n            }\n          })\n\n          if (+data.code === 0) {\n            already = data.fileList\n          }\n        } catch (err) {\n        }\n\n        // \u5b9e\u73b0\u6587\u4ef6\u5207\u7247\u5904\u7406\u3010\u56fa\u5b9a\u6570\u91cf & \u56fa\u5b9a\u5927\u5c0f\u3011, \u4f7f\u7528 file.slice \u8fdb\u884c\u5207\u7247\n        let maxSize = 1024 * 100 // \u6700\u5927\u5207\u7247\u5927\u5c0f\n        let count = Math.ceil(file.size / maxSize) // \u5207\u7247\u6570\u91cf\n        if (count > 100) {\n          maxSize = file.size / 100\n          count = 100\n        }\n\n        // \u5f00\u59cb\u5207\u7247\n        let index = 0\n        const chunks = []\n        while (index < count) {\n          chunks.push({\n            hash: hash,\n            file: file.slice(index * maxSize, (index + 1) * maxSize),\n            filename: `${hash}_${index + 1}.${suffix}`\n          })\n          index++\n        }\n\n        // \u4e0a\u4f20\u6210\u529f\u7684\u5904\u7406\n        index = 0\n        const complate = async () => {\n          // \u7ba1\u63a7\u8fdb\u5ea6\u6761\n          index++\n          upload_percent.innerHTML = `${(index / count * 100).toFixed(2)}%`\n\n          // \u6240\u6709\u5207\u7247\u90fd\u4e0a\u4f20\u6210\u529f\u4e86\uff0c\u6211\u4eec\u5408\u5e76\u5207\u7247\n          if (index < count) return\n          upload_percent.innerHTML = `100%`\n\n          try {\n            data = await instance.post('/getData', {hash, count}, {\n              headers: {\n                'Content-Type': 'application/x-www-form-urlencoded'\n              }\n            })\n            if (+data.code === 0) {\n              alert(`\u6587\u4ef6\u4e0a\u4f20\u6210\u529f\uff0c\u901a\u8fc7${data.servicePath}\u8bbf\u95ee\u8d44\u6e90`)\n              return\n            }\n            throw data.codeText\n          } catch (err) {\n            alert('\u5207\u7247\u5408\u5e76\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5')\n          } finally {\n            changeDisabel(false)\n            isRun = false\n          }\n        }\n\n        chunks.forEach(chunk => {\n          // \u5df2\u7ecf\u4e0a\u4f20\u7684\u65e0\u9700\u518d\u4e0a\u4f20\n          if (already.length > 0 && already.includes(chunk.filename)) {\n            complate()\n            return\n          }\n          const formData = new FormData()\n          formData.append('file', chunk.file)\n          formData.append('filename', chunk.filename)\n          formData.append('hash', chunk.hash)\n\n          instance.post('/upload', formData).then(data => {\n            if (+data.code === 0) {\n              complate()\n              return\n            }\n            return Promise.reject(data.codeText)\n          }).catch(err => {\n            console.log('\u5f53\u524d\u5207\u7247\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5')\n          })\n        })\n      } else {\n        // \u5c0f\u6587\u4ef6\u56fe\u7247\n        const base64 = await changeBase64(file)\n        // \u6587\u4ef6\u9884\u89c8\uff0c\u5c31\u662f\u663e\u793a base64\n        upload_abbre_img.src = base64\n\n        try {\n          const data = await instance.post('/upload', {\n            file: encodeURIComponent(base64),\n            filename: file.name\n          }, {\n            headers: {\n              'Content-Type': 'application/x-www-form-urlencoded'\n            }\n          })\n          if (+data.code === 0) {\n            alert(`\u6587\u4ef6\u4e0a\u4f20\u6210\u529f\uff0c\u901a\u8fc7${data.servicePath}\u8bbf\u95ee\u8d44\u6e90`)\n            return\n          }\n\n          throw data.codeText\n        } catch (err) {\n          alert('\u6587\u4ef6\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5')\n        } finally {\n          changeDisabel(false)\n          isRun = false\n        }\n      }\n    }\n\n    const changeDisabel = flag => {\n      if (flag) {\n        upload_button_select.classList.add('loading')\n        upload_abbre.style.display = 'none'\n        upload_ing.style.display = 'flex'\n        return\n      }\n      upload_button_select.classList.remove('loading')\n      upload_abbre.style.display = 'block'\n      upload_ing.style.display = 'none'\n    }\n\n    // \u6587\u4ef6\u8bfb\u53d6\u6210\u4e3a base64\n    const changeBase64 = file => {\n      return new Promise(resolve => {\n        const fileReader = new FileReader()\n        fileReader.readAsDataURL(file)\n        fileReader.onload = ev => {\n          resolve(ev.target.result)\n        }\n      })\n    }\n\n    // \u62d6\u62fd dragenter dragleave dragover drop\n    // upload.addEventListener('dragenter', function () {\n    // })\n    // upload.addEventListener('dragleave', function () {\n    // })\n    upload.addEventListener('dragover', function (e) {\n      e.preventDefault()\n    })\n    upload.addEventListener('drop', function (e) {\n      e.preventDefault()\n      const file = e.dataTransfer.files[0]\n      if (!file) return\n\n      uploadFile(file)\n    })\n\n    // \u76d1\u542c\u7528\u6237\u9009\u62e9\u6587\u4ef6\u7684\u64cd\u4f5c\n    upload_inp.addEventListener('change', async function () {\n      const file = upload_inp.files[0]\n      if (!file) return\n\n      uploadFile(file)\n    })\n  })();\n<\/script>\n"))),(0,r.kt)("p",null,"\u540e\u7aef\u5904\u7406\u6587\u4ef6\u4e0a\u4f20\u7684 nodejs \u6d4b\u8bd5\u4ee3\u7801"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u5229\u7528 express \u6846\u67b6"),(0,r.kt)("li",{parentName:"ul"},"\u4f7f\u7528 multer \u5904\u7406 ",(0,r.kt)("inlineCode",{parentName:"li"},"form-data")," \u4e0a\u4f20"),(0,r.kt)("li",{parentName:"ul"},"\u4f7f\u7528 body-parser \u5904\u7406 ",(0,r.kt)("inlineCode",{parentName:"li"},"x-www-form-urlencoded")," \u53c2\u6570"),(0,r.kt)("li",{parentName:"ul"},"\u4f7f\u7528 spark-md5 \u5904\u7406 base64 \u6587\u4ef6\u552f\u4e00 hash \u540d\u79f0"),(0,r.kt)("li",{parentName:"ul"},"getData \u65b9\u6cd5\u7528\u4e8e\u83b7\u53d6\u5207\u7247\u6570\u91cf\u3001\u63a5\u6536\u4e0a\u4f20\u5b8c\u6210\u5408\u5e76\u5207\u7247"),(0,r.kt)("li",{parentName:"ul"},"upload \u65b9\u6cd5\u7528\u4e8e\u5904\u7406\u4e0a\u4f20\u666e\u901a\u6587\u4ef6\u3001base64\u683c\u5f0f\u6587\u4ef6")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const express = require('express')\nconst app = express()\nconst multer = require('multer')\nconst bodyParser = require('body-parser')\nconst sparkMD5 = require('spark-md5')\n\n//\u5f15\u5165 path \u548c fs\nconst path = require('path')\nconst fs = require('fs')\n\nconst upload = multer({dest: './uploads/'})\nconst sleep = () => new Promise(resolve => {\n  setTimeout(resolve, 1000)\n})\n\napp.use(upload.any())\napp.use(bodyParser.urlencoded({extended: false, limit: '2100000kb'}))\n\n//\u8bbe\u7f6e\u8de8\u57df\u8bbf\u95ee\napp.all('*', (req, res, next) => {\n  res.header(\"Access-Control-Allow-Origin\", \"*\");\n  res.header(\"Access-Control-Allow-Headers\", \"X-Requested-With\");\n  res.header(\"Access-Control-Allow-Methods\", \"PUT,POST,GET,DELETE,OPTIONS\");\n  res.header(\"X-Powered-By\", ' 3.2.1')\n  res.header(\"Content-Type\", \"application/json;charset=utf-8\");\n  next();\n});\n\napp.post('/getData', async function (req, res) {\n  const body = req.body\n  if (body.hash && body.suffix) {\n    const newDir = path.join(__dirname, `/uploads/${body.hash}`)\n    if (!fs.existsSync(newDir)) {\n      fs.mkdirSync(newDir)\n    }\n\n    const files = fs.readdirSync(newDir)\n    res.send({\n      code: 0,\n      codeText: '\u8bf7\u6c42\u6210\u529f',\n      fileList: files\n    })\n  } else if (body.hash && body.count) {\n    const newDir = path.join(__dirname, `/uploads/${body.hash}`)\n    const files = fs.readdirSync(newDir)\n    const extname = path.extname(files[0])\n    const newFile = newDir + extname\n\n    files.sort((a, b) => {\n      const reg = /_(\\d+)/\n      return reg.exec(a)[1] - reg.exec(b)[1]\n    }).forEach(file => {\n      fs.appendFileSync(newFile, fs.readFileSync(newDir + '/' + file))\n      fs.unlinkSync(newDir + '/' + file)\n    })\n\n    fs.rmdirSync(newDir)\n    res.send({\n      code: 0,\n      codeText: '\u5408\u5e76\u6210\u529f',\n      originalFilename: body.filename,\n      servicePath: 'http://localhost:8888/uploads/' + body.hash + extname\n    })\n  }\n})\n\napp.post('/upload', function (req, res) {\n  // \u5904\u7406 multipart/form-data \u65b9\u5f0f\n  if (req.files) {\n    const file = req.files[0]\n    const body = req.body\n    // \u62ff\u5230\u540e\u7f00\u540d\n    let extname = path.extname(file.originalname);\n    //\u62fc\u63a5\u65b0\u7684\u6587\u4ef6\u8def\u5f84\uff0c\u6587\u4ef6\u52a0\u4e0a\u540e\u7f00\u540d\n    let newPath = file.path + extname;\n\n    if (body.hash && body.filename) {\n      const newDir = `uploads/${body.hash}`\n      newPath = `${newDir}/${body.filename}`\n    }\n\n    //\u91cd\u547d\u540d\n    fs.rename(file.path, newPath, async function (err) {\n      // await sleep()\n\n      if (err) {\n        res.send({\n          code: 1,\n          codeText: err\n        })\n      } else {\n        res.send({\n          code: 0,\n          codeText: '\u4e0a\u4f20\u6210\u529f',\n          originalFilename: file.originalname,\n          servicePath: 'http://localhost:8888/' + newPath\n        })\n      }\n    })\n  } else if (req.body) { // \u5904\u7406  application/x-www-form-urlencoded \u65b9\u5f0f\n    const body = req.body\n    //\u8fc7\u6ee4data:URL\n    const base64Data = decodeURIComponent(body.file).replace(/^data:image\\/\\w+;base64,/, \"\");\n    const dataBuffer = Buffer.from(base64Data, 'base64');\n    // \u5229\u7528\u6269\u5c55\u751f\u4ea7\u552f\u4e00 md5 \u540d\u5b57\n    const spark = new sparkMD5.ArrayBuffer()\n    spark.append(base64Data)\n    // \u62ff\u5230\u540e\u7f00\u540d\n    const extname = path.extname(body.filename);\n    // \u65b0\u8def\u5f84\n    const newPath = '/uploads/' + spark.end() + extname\n    // base64 \u5199\u5165\u6587\u4ef6\n    fs.writeFile(path.join(__dirname) + newPath, dataBuffer, async function (err) {\n      // await sleep()\n\n      if (err) {\n        res.send({\n          code: 1,\n          codeText: err\n        })\n      } else {\n        res.send({\n          code: 0,\n          codeText: '\u4e0a\u4f20\u6210\u529f',\n          originalFilename: body.filename,\n          servicePath: 'http://localhost:8888' + newPath\n        })\n      }\n    })\n  }\n})\n\n\napp.listen(8888, function () {\n  console.log('Server is running at http://localhost:8888');\n})\n")))}f.isMDXComponent=!0}}]);